name: Test with PostgreSQL 13

on:
  push:
    branches:
      - main

jobs:
  postgres:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:13
        env:
          POSTGRES_USER: exampleuser
          POSTGRES_PASSWORD: examplepassword
          POSTGRES_DB: exampledb
        ports:
          - 5432:5432
        options: --health-cmd="pg_isready -U exampleuser" --health-timeout=30s --health-start-period=5s --health-retries=5

    steps:
      - name: Check out the repository
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Wait for PostgreSQL to be ready
        run: |
          echo "Waiting for PostgreSQL to be ready..."
          until docker exec $(docker ps -q -f ancestor=postgres:13) pg_isready -U exampleuser; do
            echo "Waiting for database..."
            sleep 2
          done

      - name: Run tests or interact with the database
        run: |
          # A partir deste ponto, o PostgreSQL já deve estar disponível na porta 5432
          # Por exemplo, se você tiver um script de teste, pode rodá-lo aqui.
          # Você pode conectar ao banco de dados com um cliente como o psql ou usar algum script de aplicação.
          echo "Running database tests..."
          docker exec $(docker ps -q -f ancestor=postgres:13) psql -U exampleuser -d exampledb -c "SELECT 1;"
